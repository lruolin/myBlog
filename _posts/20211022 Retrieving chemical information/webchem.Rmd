---
title: "Retrieving chemical information from the web"
description: |
  Webchem: a very useful package!
author:
  - name: lruolin
date: 10-15-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

# Background

Before I knew how to export the database out from FlavorBase (a commercial flavor database), I had to type CAS numbers and FEMA numbers manually. I wished there was a way for me to tap on the existing open-source web resources, and at that time, I came across the webchem package, but I had little coding skills and did not know how to iteratively query for multiple compounds. 

I revisited the package, and as a continuation for my start to pdf scraping, let me try to append chemical information to the compounds!

It loads data from 14 web databases, although you may need to have the API accounts for some of them. 

The codes below are for searching from open-source databases.

# Learning points

- rOpenSci is an interesting community which I should check out.
- This is a great open source package which is really helpful for my day to day work
- map function is really handy, and I practiced my coding in another way (previously I tried to automate EDA using ggplots).


# Load packages

```{r, message=FALSE}
library(pacman)
p_load(datapasta, tidyverse, webchem, readxl, writexl, janitor)
```

# What I learnt from the package documentation

The codes below were taken from the package documentation and are the more commonly used functions for my case.


CIR can resolve can be of the following identifier: 

- Chemical Names, IUPAC names, CAS Numbers, SMILES strings
- IUPAC InChI/InChIKeys, NCI/CADD Identifiers, CACTVS HASHISY
- NSC number, PubChem SID, ZINC Code, ChemSpider ID, ChemNavigator SID 
- eMolecule VID

## Search for CAS number

```{r}

cir_query("allyl propyl disulfide", representation = "cas",
          match = "first") # search by name
```

## Search for names

```{r}

cir_query("Vanillin", representation = "names") # search by name
cir_query("Vanillin", representation = "names", match = "first") # first match only
cir_query("121-33-5", representation = "names") # search by CAS

# multiple inputs ------
comp <- c("Vanillin", "Ethyl vanillin")

cir_query(comp, "cas", match = "first")

```

## Search for molecular weight

```{r}
cir_query("Vanillin", representation = "mw")
```

## Search for Formula

```{r}
cir_query("Vanillin", representation = "formula")
```

## Search for number of rings

```{r}
cir_query("Vanillin", representation = "ring_count")

```

## Search for log-octanol water partition

This value is greater than 1 if the compound is more hydrophobic/non-polar, and is less than 1 if the compound is more hydrophilic/polar.

```{r}
cir_query("Vanillin", representation = "xlogp2")
```

## Search on whether compound is Aromatic

```{r}
cir_query("Vanillin", representation = "aromatic")

```

## Search for SMILES

```{r}
cir_query("Vanillin", representation = "smiles")
```

## Search for InCHI key

```{r}

cir_query("Vanillin", representation = "stdinchi")
cir_query("Vanillin", representation = "stdinchikey")
```


## Formatting CAS numbers

```{r}
as.cas("121335")
```

# Retrieving flavor perceptions from <www.flavornet.org>

This is not the most comprehensive database and I prefer the output from Flavorbase. Perhaps, if I can successfully use the data from Fenerolli's book, that would be a good addition for aroma and taste descriptors.

```{r}

cir_query("123-32-0", "names")
fn_percept("123-32-0")

# multiple input
CASs <- c("75-07-0", "64-17-5", "109-66-0", "78-94-4", "78-93-3")
fn_percept(CASs)

```

## Search for Kovats Index

The types of retention indices included in NIST include Kovats ("kovats"), Van den Dool and Kratz ("linear"), normal alkane ("alkane"), and Lee ("lee").

You can choose to specify your search limits. 

```{r}

# Search NIST RI ------
nist_ri("123-32-0",
        from = "cas",
        type = "kovats",
        polarity = "non-polar")
```

# Defining functions 

The map function from purrr is extremely handy here!

```{r}
# define a function to search cas

search_cas <- function(chem_name) {
  webchem::cir_query({{chem_name}}, representation = "cas",
                     match = "first") %>% 
    unlist(.) 
}




# define a function to search mw

search_mw <- function(cas) {
  webchem::cir_query({{cas}}, representation = "mw") %>% 
    unlist(.) %>% 
    as.numeric()
}


# define a function to search formula

search_formula <- function(cas) {
  webchem::cir_query({{cas}}, representation = "formula") %>% 
    unlist(.) 
}

# define a function to search log-ow

search_log_o_w <- function(cas) {
  webchem::cir_query({{cas}}, representation = "xlogp2") %>% 
    unlist(.) 
}

# define a function to search fnpercep

search_flv_percept <- function(cas) {
  webchem::fn_percept({{cas}}) %>% 
    unlist(.) 
}

# define a function for NIST KI

search_nist_ki <- function(cas) {
  ri <- nist_ri("123-32-0",
        from = "cas",
        type = "kovats",
        polarity = "non-polar")
  
  round(mean(ri$RI), 1)
}

```

# Searching for multiple compounds

Let's just randomly pick three compounds

```{r}

chem_names <- tibble::tribble(
  ~chem_names,
  "ethyl vanillin",
  "ethyl butyrate",
  "2,6-dimethylpyrazine"
)

# merge in

report_expanded <- chem_names %>% 
  mutate(cas = map_chr(chem_names, search_cas)) %>% 
  mutate(mw = map_dbl(cas, search_mw)) %>% 
  mutate(chem_form = map_chr(cas, search_formula)) %>% 
  mutate(log_o_w = map_dbl(cas, search_log_o_w)) %>% 
  mutate(flv_percept = map_chr(cas, search_flv_percept)) 

report_expanded
```




# Using an existing excel file and looking up information

I am not uploading my excel file (with compounds to query for) in this case, but here is an example code. I would need to import two files:

- report file
- in house database file (this contains the sensory descriptors, historical KI)

I would query for each of the compound iternatively.

```{r, eval = F}
# load packages ------
library(pacman)
p_load(datapasta, tidyverse, webchem, readxl, writexl, janitor)

# import report ------

data <- read_xlsx("import_data.xlsx") %>% 
  clean_names() %>% 
  select(-tent_t, -fema_raw)

glimpse(data)

# import in-house database, use latest version ------

in_house_db <- read_excel("in_house.xlsx") %>% 
  clean_names() %>% 
  select(ends_with("combined"), lri_db_1_text, lri_db_5_text, lri_wax_text) %>% 
  distinct(cas_combined, .keep_all = T)

glimpse(in_house_db)

# merge in sensory descriptor ------

data_sensory_desc <- data %>% 
  left_join(in_house_db, by = c("cas" = "cas_combined")) %>% 
  select(-lri_db_1_text, -compound_combined, -fema_combined)

glimpse(data_sensory_desc)

# merge in webchem queries
data_pubchem <- data_sensory_desc %>% 
  mutate(mw = map_chr(cas, search_mw)) %>% 
  mutate(chem_form = map_chr(cas, search_formula)) %>% 
  mutate(log_o_w = map_dbl(cas, search_log_o_w)) %>% 
  mutate(flv_percept = map_chr(cas, search_flv_percept)) %>% 
  mutate(nist_ki = map_dbl(cas, search_nist_ki))

glimpse(data_pubchem)  

```



# Reference:

- <https://www.jstatsoft.org/article/view/v093i13>

---
title: "Data transformation"
description: |
  R4DS 03 - Data transformation with dplyr
author:
  - name: lruolin
date: 04-28-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R4DS Practice 03: Data transformation with dplyr

The codes below are from R4DS book by Hadley Wickham. 

Loading required packages:
```{r}
library(tidyverse)
library(nycflights13)
```

The nycflights13 dataset contains all 336,776 flights that departed from New York City in 2013. The data comes from US Bureau of Transportation Statistics. 

```{r}
head(flights)
```

# Learning filter()

Selecting all flights on Jan 1st:

```{r}
filter(flights, month == 1, day == 1) # filter month = 1 (Jan) and day = 1 (1st)

# to filter for flights on xmas day
flights %>% 
  filter(month == 12, day == 25)

# to filter for flights departing in nov and dec
flights %>% 
  filter(month %in% c(11, 12))
```
### Exercise questions:

Q1 - Find all flights that had an arrival delay of two or more hours

```{r}
flights %>% 
  filter(arr_delay >= 120)

```


Q2 - Flew to Houston (IAH or HOU)

```{r}
flights %>% 
  filter(dest %in% c("IAH", "HOU"))
```


Q3 - Were operated by United, American or Delta

```{r}
flights %>% 
  filter(carrier %in% c("UA", "AA", "DL"))
```
Q4 - Departed in July, August, and September

```{r}
flights %>% 
  filter(month %in% c(7:9))
```
Q5 - Arrived more than two hours late, but didn't leave late

```{r}
flights %>% 
  filter(arr_delay >= 120, dep_delay <=0)
```
Q6 - Were delayed by at least an hour, but made up over 30 minutes in flight

```{r}
flights %>% 
  filter(dep_delay >=60, dep_delay - arr_delay >30)
```

Q7 - Departed between midnight and 6am

```{r}
flights %>% 
  filter(dep_time <= 600 | dep_time == 2400)
```

Using the between function to filter flights that departed in summer:

```{r}
flights %>% 
  filter(between(month, 7, 9))
```
How many flights have a missing dep_time?

```{r}
flights %>% 
  filter(is.na(dep_time))
```
# Learning arrange()

```{r}
flights %>% 
  arrange(year, month, day)

flights %>% 
  arrange(desc(month))
```
## Exercises

Using arrange() to sort all the missing values to the start?

```{r}
flights %>% 
  arrange(desc(is.na(dep_time), dep_time))
```
Sort flights to find the most delayed flights:

```{r}
flights %>% 
  arrange(desc(dep_delay))
```
Sort flights that left the earliest

```{r}
flights %>% 
  arrange(dep_delay)
```
Sort flights to find the fastest flights

```{r}
flights %>% 
  arrange(air_time) %>% 
  head()
```

Which flights traveled the shortest?

```{r}
flights %>% 
  arrange(air_time) %>% 
  head()
```

which flights travelled the longest?

```{r}
flights %>% 
  arrange(desc(air_time))
```
# Learning select()

```{r}
# Selecting columns by name

flights %>% 
  select(year, month, day)

# Select all columns between year and day

flights %>% 
  select(year:day)

# Select all columns except those from year to day

flights %>% 
  select(-(year:day))

# Select() with everything()

flights %>% 
  select(time_hour, air_time, everything())
```
Variables may also be defined and called upon using all_of() and any_of()

```{r}
vars <- c("year", "month", "day", "dep_delay", "arr_delay")

flights %>% 
  select(all_of(vars))

flights %>% 
  select(any_of(vars))
```
Selecting variables that contain "time"

```{r}
flights %>% 
  select(contains("time"))
```
# Learning mutate()

## Questions

1. Currently dep_time and sched_dep_time are convenient to look at but hard to compute with because they are not really continuous numbers. Convert them to a more convenient representation of number of minutes since midnight

```{r}
flights %>% 
  select(dep_time, sched_dep_time) %>% 
  mutate(dep_time_mins = (dep_time %/% 100 * 60 + dep_time %% 100) %% 1440,
         sched_dep_time_mins = (sched_dep_time %/% 100 * 60 + sched_dep_time %% 100) %% 1440)
```

2. Compare air_time with arr_time - dep_time. 

```{r}
flights %>% 
  mutate((dep_time = dep_time %/% 100*60 + dep_time %/% 100) %% 1440,
         arr_time = (arr_time %/% 100*60 + arr_time %% 100) %% 1440,
         air_time_diff = air_time - (arr_time + dep_time)) %>% 
  filter(air_time_diff != 0)

# check if air_time_diff = 0 

```
There are many flights in which there was a difference. This could be because some flights passed midnight, or crossed time zones. 

# Learn summarize(), group_by()

To find out mean delay for each month in each year:
```{r}
flights %>% 
  group_by( year, month, day) %>% 
  summarize(delay = mean(dep_delay, na.rm = T))
```

To explore the relationship between distance and average delay for each location:

```{r}
flights %>% 
  group_by(dest) %>% 
  summarize(count = n(),
            dist = round(mean(distance, na.rm = T), 2),
            delay = round(mean(arr_delay, na.rm = T), 2)) %>% 
  filter(count > 20, dest != "HNL") %>% 
  ggplot(aes(x = dist, y = delay)) +
  geom_point(aes(size = count, alpha = 0.4)) +
  geom_smooth(se = F) +
  theme_classic() +
  theme(legend.position = "none")

```

# References:

<https://jrnold.github.io/r4ds-exercise-solutions/>
<https://r4ds.had.co.nz/>

---
title: "Weekly Stock Market Data (ISLR2)"
description: |
  Predicting whether stock moves Up or Down
author:
  - name: lruolin
date: 10-27-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

A simple exercise to understand how to run logistic regression with stock market data using the weekly dataset.

# Learning points:

- Customizing my own functions for EDA, and using patchwork to join plots
- Time series plot - using lubridate (EDA)
- Fitting logistic regression on the whole dataset, using non-tidymodel and tidymodel framework; as well as on train and test dataset.
- Generating confusion matrix


# Packages

```{r}
library(pacman)
p_load(ISLR2, tidyverse, tidymodels, janitor, GGally,
       workflows, yardstick, discrim, skimr, ggsci,
       patchwork, ggstatsplot)

theme_set(theme_classic())
```

# Data

This dataset consists of 1,089 weekly returns for 21 years, from the beginning of 1990 to end of 2010. 


```{r}
stock_market <- Weekly %>% 
  clean_names() 

head(stock_market)
glimpse(stock_market) # 1,089 x 9

```

# EDA

```{r}
summary(stock_market)
```


```{r}
stock_market %>% 
  skim()

```


```{r}
stock_market %>% 
  ggpairs()
```

# A more colorful correlation matrix:

```{r}
stock_market %>% 
  ggstatsplot::ggcorrmat()
```

Not much correlation except between volume and today. 

## A simple ggplot for factor variable (direction):

This plot shows the proportion
```{r}
stock_market %>% 
  group_by(direction) %>% 
  summarize(n = n(), .groups = "drop") %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(direction, prop, label = scales::percent(prop))) +
  geom_col(aes(fill = direction), show.legend = F) +
  geom_text(vjust = -1) + 
  scale_fill_jco() +
  theme_classic() +
  labs(title = "Direction") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  theme(axis.title = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"))
```


## ggplot for numerical variables - geom_freqpoly

A simple plot:

```{r}
stock_market %>% 
  ggplot(aes(lag1)) + 
  geom_freqpoly(size = 1) +
  theme_classic() +
  labs(title = "lag1") +
  theme(axis.title = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"))
  
```

A function:

```{r}
plot_many_freqpoly <- function(var_x) {

  stock_market %>% 
  ggplot(aes({{var_x}})) +
  geom_freqpoly(size = 1) +
  theme_classic() +
  labs(title = str_to_title(as_label(enquo(var_x))),
       x = as_label(enquo(var_x))) +
  theme(axis.title = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"))
}
```

```{r}
plot_many_freqpoly(lag3)
```

```{r}
# set names to loop through
num_var <- stock_market %>% 
  select(-year) %>% 
  select_if(is.numeric) %>% 
  names()

# let the iterations begin
num_var %>% 
  syms() %>%  # take strings as input and turn them into symbols
  map(function(var) plot_many_freqpoly({{var}})) %>% 
  wrap_plots() # from patchwork

```

## Plot of numerical variables against year

```{r}
stock_market %>% 
  count(year)

# create sequence for number of weeks in data

stock_market_wk <- stock_market %>% 
  group_by(year) %>% 
  mutate(week = row_number()) %>% # create number of weeks
  ungroup() %>% 
  mutate(week_digit = str_pad(week, width = 2, pad = "0")) %>% # create 2 digits
  # Y: year, W: week number, w: weekday number
  mutate(date = lubridate::parse_date_time(paste(year, week_digit, 1, sep = "/"),
                                           "Y/W/w")) %>% 
  select(-week, -week_digit) %>% 
  select(year, date, everything())
  

glimpse(stock_market_wk)
```


```{r}
# create ggplot of y vs year

stock_market_wk %>% 
  ggplot(aes(date, volume)) +
  geom_line() +
  theme_classic() +
  labs(title = "Plot of Vol over time") +
  theme(axis.title = element_text(face = "bold"),
        axis.text = element_text(face = "bold"))

# create function

plot_over_time <- function(var_y){
  stock_market_wk %>% 
  ggplot(aes(date, {{var_y}})) +
  geom_line() +
  theme_classic() +
  labs(title = str_c(str_to_title(as_label(enquo(var_y))),
                     " over time")) +
  theme(axis.title = element_text(face = "bold"),
        axis.text = element_text(face = "bold"))
}

# set names to loop through
num_var # from previous

# iterate
num_var %>% 
  syms() %>%  # take strings as input and turn them into symbols
  map(function(var) plot_over_time({{var}})) %>% 
  wrap_plots() # from patchwork

```

# Logistic regression on full dataset

Use the full dataset to perform a logistic regression with Direction as the response (Y) and the five lag variables plus Volume as the predictors (X). 

Use the summary function to print the results.

Do any of the predictors appear to be statistically significant? -- Yes, lag2

```{r}
log_reg_main_e <- glm(direction ~ lag1 + lag2 + lag3 + lag4 + lag5 + volume,
                      data = stock_market, 
                      family = binomial(link = "logit"))

summary(log_reg_main_e)

# tidy format
tidy(log_reg_main_e)
glance(log_reg_main_e)
```

Compute the confusion matrix and overall fraction of correct predictions. 

```{r}
pred <- stock_market %>% 
  mutate(pred = predict(log_reg_main_e,., type = "response"),
         pred_dir = case_when(pred >0.5 ~"up", # down: 0, up: 1; alphabetical
                              TRUE ~ "down"),
         dir_fct = as.factor(if_else(direction == "Up", "up", "down")),
         pred_dir_fct = as.factor(if_else(pred_dir == "up", "up", "down"))) 
  

glimpse(pred)

stock_market %>% 
  count(direction)

pred %>% 
  count(dir_fct)

pred %>% 
  count(pred_dir_fct)

# the predicted model will predict more likely as Up when it is actually Down.
# low sensitivity: % that is really UP is predicted to be down

library(caret)
confusionMatrix(data= pred$pred_dir_fct, # predicted
                reference = pred$dir_fct) # true 
```


Tidymodels framework:

```{r}
tm_log_reg <- logistic_reg() %>% 
  set_engine("glm") %>% 
  set_mode("classification")
```

```{r}
tm_log_reg_fit <- 
  tm_log_reg %>% 
  fit(direction ~ lag1 + lag2 + lag3 + lag4 + lag5 + volume, data = stock_market)

tm_log_reg_fit

tm_log_reg_fit %>% 
  pluck("fit") %>% 
  summary()

predict(tm_log_reg_fit, new_data = stock_market)

augment(tm_log_reg_fit, new_data = stock_market) %>% 
  conf_mat(truth = direction, estimate = .pred_class) %>% 
  autoplot(type = "heatmap")

augment(tm_log_reg_fit, new_data = stock_market) %>% 
  accuracy(truth = direction, estimate = .pred_class)
```


# Fit logistic regression on training data

Training data: from 1990 - 2008
Test data: 2009 - 2010
with lag2 as the only predictor

## Split data

```{r}
set.seed(20211103)

train_data <- stock_market %>% 
                filter(!year %in% c(2009, 2010))

test_data <- stock_market %>% 
              filter(year %in% c(2009, 2010))
```

## Create model

The same model can be used, but I will just create again.

```{r}
lr_model <- 
  logistic_reg() %>% 
  set_engine("glm")

```


## Create recipe 

```{r}

stock_recipe <- 
  recipe(direction ~ lag2, data = train_data)

summary(stock_recipe)
```

## Create workflow

```{r}
stock_workflow <- 
  workflow() %>% 
  add_model(lr_model) %>% 
  add_recipe(stock_recipe)

stock_workflow
```

# Fit data

```{r}
stock_fit <- 
  stock_workflow %>% 
  fit(data = train_data)
```

```{r}
stock_fit %>% 
  extract_fit_parsnip() %>% 
  tidy()
```

## Predict

```{r}

predict(stock_fit, test_data)

stock_augment <- 
  augment(stock_fit, test_data) %>% 
  select(year, direction, .pred_class, .pred_Down, .pred_Up)

stock_augment
```

## Confusion matrix and accuracy

```{r}
stock_augment %>% 
  conf_mat(truth = direction, estimate = .pred_class)

stock_augment %>% 
  accuracy(truth = direction, estimate = .pred_class) # 62.5%

metrics <- metric_set(accuracy, sens, spec)
metrics(stock_augment,
        truth = direction,
        estimate = .pred_class)
```


```{r}
stock_augment %>% 
  roc_curve(truth = direction, .pred_Down) %>% 
  autoplot()

stock_augment %>% 
  roc_auc(truth = direction, .pred_Down) # 0.52

```

# Reference:

- [ISLR2 book] (https://web.stanford.edu/~hastie/ISLRv2_website.pdf)

- <https://www.tidymodels.org/start/recipes/>

- <https://discrim.tidymodels.org/reference/discrim_linear.html>

- <https://discrim.tidymodels.org/reference/discrim_quad.html>

- <https://stackoverflow.com/questions/32470414/convert-week-number-to-date>

- <https://www.kirenz.com/post/2021-02-17-r-classification-tidymodels/>

- <https://rstudio-pubs-static.s3.amazonaws.com/290310_86f15a6b4efa4085beb912cf0ef757d6.html>

- <https://emilhvitfeldt.github.io/ISLR-tidymodels-labs/classification.html>